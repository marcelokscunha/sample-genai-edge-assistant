version: 1
backend:
  phases:
    preBuild:
      commands:
        - REPO_ROOT=$(pwd)
        - echo "Deploying backend!"
        - cd backend
        - python -m venv venv
        - source venv/bin/activate
        - pip install --upgrade pip
        - pip install -r requirements.txt
        - pip install aws-cdk-lib
        - npm install -g aws-cdk
    build:
      commands:
        - PYTHONPATH=./shared/ cdk bootstrap --context amplify_app_id=$AWS_APP_ID
        - PYTHONPATH=./shared/ cdk deploy --context amplify_app_id=$AWS_APP_ID --require-approval never
        - PYTHONPATH=./shared/ python ./resources/sagemaker/sagemakerpipeline/pipelines_resources_creation.py
        # TODO: auto train, approve models to publish
  cache:
    paths:
      - backend/venv/**/*
frontend:
  phases:
    preBuild:
      commands:
        - cd $REPO_ROOT
        - echo "Deploying frontend!"
        - cd visual_assistant_js
        - sudo cp -r libvips_x64/* /usr/lib64/
        - sudo ldconfig
        - npm ci
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: visual_assistant_js/out
    files:
      - "**/*"
  cache:
    paths:
      - visual_assistant_js/.next/cache/**/*
      - visual_assistant_js/.npm/**/*
      - visual_assistant_js/node_modules/**/*